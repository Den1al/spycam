from flask import Flask, render_template, request, jsonify
from flask_sqlalchemy import SQLAlchemy
import json
import time
import datetime
from sqlalchemy.sql.expression import func

from signature import validate_signature

app = Flask(__name__)
app.secret_key = b'\x0f\x94;\xef\x1d\n\x8e\x0b{ '
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///database.sqlite3'
db = SQLAlchemy(app)

class SecretAgent(object):
    def __init__(self, name, descriptor):
        self.name = name
        self.descriptor = descriptor

SECRET_AGENTS = [
    SecretAgent('James Bond', [-0.0351337231695652,0.14789226651191711,0.07996691018342972,-0.11367440223693848,-0.13884493708610535,0.010505488142371178,-0.07579553872346878,-0.07189477980136871,0.15818481147289276,-0.08565497398376465,0.23474448919296265,0.041783951222896576,-0.22480826079845428,-0.1433972716331482,-0.013372467830777168,0.056998562067747116,-0.1498112827539444,-0.13740065693855286,-0.04926915839314461,0.054198529571294785,0.06967871636152267,0.016430804505944252,0.04154280573129654,0.07522227615118027,-0.07348287850618362,-0.34410616755485535,-0.05950235575437546,-0.06706476956605911,0.06463216990232468,-0.1587405651807785,-0.054499462246894836,0.06433252990245819,-0.2377614974975586,-0.12642785906791687,-0.03364958614110947,0.09472551941871643,-0.12916573882102966,-0.1431129276752472,0.15103359520435333,0.002860955661162734,-0.12666477262973785,0.059410035610198975,-0.07402931153774261,0.23554883897304535,0.17315635085105896,0.06419996917247772,0.02422690950334072,-0.062422975897789,0.1552973836660385,-0.2989010214805603,0.03735126554965973,0.18883979320526123,0.13630351424217224,0.09298045933246613,0.05834195390343666,-0.20937469601631165,0.1363610029220581,0.11135069280862808,-0.2784280478954315,0.04105667769908905,-0.026524145156145096,-0.13391944766044617,0.04642432928085327,-0.08263929933309555,0.23568762838840485,0.1043332889676094,-0.06893842667341232,-0.08888846635818481,0.15999919176101685,-0.07254122942686081,-0.03793037310242653,0.09292829036712646,-0.10425508767366409,-0.17664891481399536,-0.1895325630903244,0.058272987604141235,0.3187193274497986,0.24021972715854645,-0.19389936327934265,0.026603735983371735,-0.14356157183647156,0.007301671430468559,-0.03328924998641014,0.010528014972805977,-0.08484223484992981,-0.046369943767786026,-0.12761190533638,0.006722987163811922,0.1332908719778061,0.007268612738698721,-0.033633604645729065,0.274159699678421,0.05272478610277176,0.06646521389484406,0.07784874737262726,-0.05055463686585426,-0.09363480657339096,0.04882868006825447,-0.095713771879673,0.055556442588567734,0.0011040543904528022,-0.1539893001317978,-0.028765423223376274,0.08363433927297592,-0.17498838901519775,0.16649022698402405,-0.010290705598890781,-0.0023814246524125338,-0.005900846794247627,-0.0873037800192833,-0.11346787959337234,0.006292362231761217,0.116973876953125,-0.3692285418510437,0.3142358064651489,0.16898611187934875,0.10066019743680954,0.21961043775081635,0.07002727687358856,0.051241349428892136,-0.018360411748290062,-0.13465632498264313,-0.13642644882202148,-0.12195279449224472,0.1308097094297409,-0.03960028290748596,0.06382473558187485,0.04432826489210129]),
    SecretAgent('Max Payne', [-0.16250033676624298,0.08402170985937119,0.030977435410022736,-0.02487541362643242,-0.10175340622663498,-0.025938605889678,-0.0138813816010952,-0.11906407028436661,0.1730516254901886,-0.081980861723423,0.14719152450561523,-0.03258837014436722,-0.28218039870262146,-0.04804399237036705,-0.0037499992176890373,0.11479680985212326,-0.14362689852714539,-0.10209500789642334,-0.14241865277290344,-0.13813352584838867,0.1309926062822342,0.08153164386749268,0.050859443843364716,-0.022568875923752785,-0.1405828893184662,-0.35869404673576355,-0.10555491596460342,-0.09498335421085358,0.05548938363790512,-0.07564456760883331,-0.045043278485536575,-0.048433709889650345,-0.17086261510849,-0.0630795881152153,0.022686349228024483,0.056216027587652206,-0.023296816274523735,-0.1102418527007103,0.1166028380393982,0.011059188283979893,-0.11589797586202621,0.054936569184064865,0.05032666400074959,0.22579827904701233,0.13731825351715088,0.02942107990384102,0.054117463529109955,-0.07534556090831757,0.09360986202955246,-0.25097453594207764,0.0762290433049202,0.09613756090402603,0.02814260683953762,0.018508363515138626,0.2312890887260437,-0.19795680046081543,-0.023056896403431892,0.16296222805976868,-0.19350823760032654,0.16218119859695435,0.06458812206983566,-0.016137897968292236,-0.06296274811029434,-0.06005297601222992,0.14611168205738068,0.13141798973083496,-0.11880633980035782,-0.15177103877067566,0.05967716872692108,-0.12756973505020142,0.03245607018470764,0.06639589369297028,-0.10564227402210236,-0.1971023827791214,-0.24652665853500366,0.08917755633592606,0.49780765175819397,0.1174258291721344,-0.1553313136100769,-0.008696179836988449,-0.03919437155127525,-0.033471159636974335,0.11516596376895905,0.004058423917740583,-0.10415658354759216,-0.00145454122684896,-0.15942125022411346,0.08899851143360138,0.15467634797096252,0.00611749105155468,-0.037115033715963364,0.2811935842037201,-0.03217191621661186,-0.01038744393736124,0.008494569920003414,0.07781600952148438,-0.21199524402618408,-0.04410482943058014,-0.05719941481947899,-0.06015652418136597,0.11957554519176483,-0.17631085216999054,-0.00988613348454237,0.061192817986011505,-0.11868777126073837,0.051013123244047165,-0.06480951607227325,-0.023215707391500473,-0.08402397483587265,-0.05018537491559982,-0.15179578959941864,0.060747791081666946,0.12060525268316269,-0.26371681690216064,0.1737193614244461,0.18988163769245148,-0.004287480842322111,0.1616385132074356,0.03264763206243515,-0.0010673963697627187,0.023753516376018524,0.038118403404951096,-0.10312258452177048,-0.07292118668556213,-0.0009558001765981317,0.012267326936125755,0.02587035298347473,0.022902419790625572]),
    SecretAgent('Nick Fury', [-0.10696344077587128,0.1396009773015976,-0.0009029102511703968,-0.026952160522341728,-0.11095330864191055,-0.0582519955933094,-0.004842197988182306,-0.10247885435819626,0.2465033084154129,-0.10085845738649368,0.19690583646297455,0.022470949217677116,-0.24830535054206848,0.08399937301874161,-0.08919502794742584,0.18157421052455902,-0.12922760844230652,-0.13699974119663239,-0.12120610475540161,-0.08692897111177444,-0.02112440951168537,0.09194829314947128,-0.013305900618433952,0.08693093061447144,-0.06717273592948914,-0.28477391600608826,-0.007563553750514984,-0.04102838784456253,0.08772269636392593,-0.03077840432524681,-0.0736132338643074,0.11285211890935898,-0.1634950041770935,-0.03764345869421959,0.16257785260677338,0.10617666691541672,-0.0929148867726326,-0.0757438987493515,0.28122007846832275,0.09894163906574249,-0.24584461748600006,-0.04275372251868248,0.03549442067742348,0.29687732458114624,0.21220803260803223,-0.054714132100343704,0.02533218078315258,-0.173586905002594,0.17189323902130127,-0.2902062237262726,0.06476069986820221,0.18662598729133606,0.09372936189174652,0.06442436575889587,0.11238504201173782,-0.22854633629322052,-0.020617565140128136,0.18918882310390472,-0.18795785307884216,-0.014477048069238663,0.07748531550168991,-0.079120934009552,-0.06968602538108826,-0.0694013461470604,0.21616747975349426,0.18688151240348816,-0.10845258831977844,-0.17796921730041504,0.25274181365966797,-0.16301961243152618,-0.03239726275205612,0.12693007290363312,-0.03144245222210884,-0.17067018151283264,-0.1763203889131546,-0.0034997211769223213,0.4526691138744354,0.17535042762756348,-0.135734423995018,0.06282367557287216,-0.09785163402557373,-0.052410583943128586,0.08706197887659073,0.0683998242020607,-0.11957890540361404,-0.019136769697070122,-0.04766938462853432,-0.033595722168684006,0.23127228021621704,0.05213702842593193,-0.03581169992685318,0.20399832725524902,-0.008722499944269657,-0.01917671225965023,0.06417392939329147,0.03054133802652359,-0.17539693415164948,-0.06675002723932266,-0.17362651228904724,-0.17121833562850952,-0.02201932854950428,-0.07637723535299301,0.03129639849066734,0.14846794307231903,-0.2553516924381256,0.13786935806274414,-0.04146452620625496,0.0022304693702608347,0.03316546976566315,-0.009028716012835503,-0.0010810927487909794,0.005397639237344265,0.11521473526954651,-0.26590070128440857,0.2258962243795395,0.0330103300511837,-0.006682060193270445,0.16861943900585175,0.06052051857113838,0.024040939286351204,0.029024358838796616,-0.10624539852142334,-0.1475289762020111,-0.09332451224327087,0.050929609686136246,-0.018468348309397697,0.05842060223221779,-0.024022672325372696]),
    SecretAgent('Elizabeth Jennings', [-0.053786661475896835,0.04265313968062401,0.10916609317064285,-0.059550024569034576,-0.08915800601243973,-0.012201338075101376,0.09089533239603043,-0.09831351041793823,0.10102040320634842,-0.08055885881185532,0.17254433035850525,-0.14757803082466125,-0.3683706820011139,0.11653651297092438,0.0006414945237338543,0.13333216309547424,-0.178803488612175,-0.1706906110048294,-0.15637001395225525,-0.02009171061217785,0.02364816889166832,0.017600195482373238,-0.059043191373348236,0.05607584863901138,-0.1316988468170166,-0.3144678771495819,-0.05739115923643112,-0.08827877044677734,0.022634534165263176,-0.07115090638399124,0.03169231116771698,0.0943402498960495,-0.11597953736782074,0.0161021389067173,0.07313801348209381,0.04219070449471474,-0.08542054146528244,-0.14952531456947327,0.21761062741279602,-0.030572427436709404,-0.2787362337112427,0.019207512959837914,0.10921771824359894,0.25021466612815857,0.11682339012622833,0.06452372670173645,-0.005641398020088673,-0.05196467041969299,0.08835571259260178,-0.3384619951248169,0.004798362962901592,0.14350508153438568,0.1513286679983139,0.07754527032375336,0.021691318601369858,-0.26124754548072815,0.04853932932019234,0.04902728274464607,-0.26081255078315735,0.07619290798902512,0.09136608988046646,-0.18301059305667877,-0.01472517754882574,-0.04581256955862045,0.19995325803756714,0.05851603299379349,-0.17143680155277252,-0.08528120070695877,0.1921541392803192,-0.1673172563314438,0.007884414866566658,0.11636049300432205,-0.10704180598258972,-0.167970672249794,-0.1598491072654724,-0.03569258004426956,0.44579771161079407,0.05402502045035362,-0.17033907771110535,-0.0216458048671484,-0.13196653127670288,0.012665064074099064,-0.006353490054607391,0.08921277523040771,-0.0417349711060524,-0.09337575733661652,-0.13947506248950958,-0.005683260969817638,0.2348291277885437,-0.1025375947356224,0.010401173494756222,0.21798887848854065,0.038372427225112915,-0.07725511491298676,-0.004001246765255928,0.04636489972472191,-0.15847471356391907,-0.06130478158593178,-0.08242234587669373,-0.051066845655441284,0.0017108693718910217,-0.08556772768497467,-0.04528359696269035,0.11508046835660934,-0.24212020635604858,0.21728812158107758,0.005791889037936926,-0.06551315635442734,0.04917177930474281,-0.029577644541859627,-0.03950733318924904,-0.04579905793070793,0.1703963428735733,-0.31055188179016113,0.10895703732967377,0.19882088899612427,0.034142203629016876,0.10672269016504288,-0.029440615326166153,0.032331131398677826,0.005151941440999508,-0.01841973140835762,-0.24812787771224976,-0.13159477710723877,0.07250227779150009,-0.02792806178331375,-0.02232522703707218,-0.003588447580114007]),
    SecretAgent('Number Six', [-0.06958028674125671,0.12918847799301147,0.017933856695890427,0.094199039041996,-0.17725728452205658,-0.055786944925785065,-0.016358347609639168,-0.09043964743614197,0.13116872310638428,-0.0644151046872139,0.08886799961328506,-0.08144214749336243,-0.2634940445423126,-0.02039461024105549,-0.022233976051211357,0.07811065018177032,-0.1037217304110527,-0.03695083037018776,-0.08294842392206192,-0.1565522849559784,-0.011404060758650303,0.06174609437584877,0.0206423569470644,0.009776170365512371,-0.09157802164554596,-0.2645969092845917,-0.017461063340306282,-0.12343235313892365,0.026140570640563965,-0.1305198222398758,0.04293748736381531,0.06555391848087311,-0.18651771545410156,-0.07746893167495728,-0.00847388245165348,0.16347268223762512,-0.09378395974636078,-0.09801033139228821,0.1439298838376999,-0.05594035983085632,-0.1351221203804016,0.056548308581113815,0.03216298297047615,0.22527380287647247,0.208518847823143,-0.08884703367948532,-0.0490754172205925,-0.02735058218240738,0.22303155064582825,-0.18830853700637817,0.05267374962568283,0.18641816079616547,0.14133328199386597,0.06833243370056152,0.07063242793083191,-0.09938952326774597,0.044999755918979645,0.17813697457313538,-0.17591258883476257,0.07358399033546448,0.15317055583000183,-0.11299882084131241,-0.014030469581484795,-0.0020712167024612427,0.06393900513648987,0.025897160172462463,-0.06601601094007492,-0.0846184641122818,0.11883991956710815,-0.17250926792621613,-0.02565578930079937,0.05111362785100937,-0.09786494076251984,-0.1834980547428131,-0.2578783333301544,0.12770691514015198,0.40383180975914,0.17124910652637482,-0.09084853529930115,0.003666226053610444,-0.06722500175237656,-0.057729508727788925,-0.05435026437044144,0.08031397312879562,-0.03575770556926727,-0.1404268443584442,-0.1433214247226715,0.08998573571443558,0.1357877254486084,-0.002953562419861555,-0.03790469467639923,0.19715949892997742,-0.029462508857250214,-0.0251865703612566,-0.04644547775387764,0.004792368970811367,-0.24036599695682526,-0.039503902196884155,-0.05873924866318703,-0.0945066586136818,0.08435013145208359,-0.22893518209457397,-0.04087018594145775,0.0994725376367569,-0.19832096993923187,0.21714386343955994,-0.03503581881523132,0.033173590898513794,0.024174487218260765,-0.05831830948591232,-0.06512625515460968,0.12921518087387085,0.21255648136138916,-0.14599400758743286,0.27760815620422363,0.06413117051124573,0.04248964786529541,0.17285743355751038,0.07079005986452103,0.0569676011800766,0.007617679890245199,-0.06236831471323967,-0.15583188831806183,-0.16678746044635773,-0.04736229032278061,0.005934444721788168,0.03665534034371376,0.06441129744052887]),
    SecretAgent('Johnny English', [-0.12029742449522018,0.1782558411359787,0.08730681240558624,0.004749452229589224,-0.0315256342291832,-0.10750076919794083,0.0667433887720108,-0.04651922360062599,0.10532627999782562,0.00783937145024538,0.35056576132774353,-0.022509688511490822,-0.18066756427288055,-0.12827010452747345,0.04805624857544899,0.11794836819171906,-0.15107394754886627,-0.1008649468421936,-0.11415141820907593,-0.08875269442796707,0.02456945739686489,0.025035489350557327,-0.01131994929164648,0.0675569474697113,-0.05179521068930626,-0.24964135885238647,-0.0400860533118248,-0.13334034383296967,0.17279808223247528,-0.13842646777629852,-0.019337238743901253,0.012312443926930428,-0.18118417263031006,-0.09344980120658875,-0.005128163844347,0.04047859087586403,0.05502202361822128,-0.024180583655834198,0.17944671213626862,0.03438173606991768,-0.13293884694576263,0.011814062483608723,-0.016305701807141304,0.3214116096496582,0.20441818237304688,-0.04091659560799599,0.0242408849298954,0.0005706414231099188,0.051301345229148865,-0.19787079095840454,0.016334280371665955,0.10631895065307617,0.23108865320682526,0.058866292238235474,-0.04143315553665161,-0.1345035880804062,-0.09206818789243698,0.04926005005836487,-0.21285021305084229,0.049107372760772705,0.06460288166999817,-0.10298436135053635,-0.11076880991458893,-0.08784886449575424,0.24644620716571808,0.07661761343479156,-0.15256141126155853,-0.14745277166366577,0.15277345478534698,-0.1280517429113388,-0.040050797164440155,0.12373065203428268,-0.1131247729063034,-0.053386855870485306,-0.22648660838603973,0.14358077943325043,0.3183671534061432,0.048572417348623276,-0.21785050630569458,-0.025176523253321648,-0.2091272920370102,-0.01284872367978096,-0.12757787108421326,0.0366719551384449,-0.057284675538539886,0.04284469410777092,-0.12654052674770355,0.029595499858260155,0.12404544651508331,-0.06116041913628578,0.019584160298109055,0.21494871377944946,-0.03463771194219589,0.005882562603801489,-0.020618734881281853,0.03039301559329033,-0.08560163527727127,-0.05529569461941719,-0.041416727006435394,-0.07963574677705765,0.04029400274157524,-0.12577128410339355,0.012241917662322521,0.10415436327457428,-0.20642465353012085,0.14328791201114655,-0.020116396248340607,0.01419851090759039,0.030419055372476578,0.014435021206736565,0.010406182147562504,-0.07712206244468689,0.1607547104358673,-0.195121631026268,0.20625081658363342,0.17262834310531616,0.027665460482239723,0.07120636105537415,0.005783263128250837,0.07949326187372208,-0.041286226361989975,-0.02116623893380165,-0.0851905569434166,-0.051263779401779175,0.011700497940182686,-0.06481635570526123,0.001463498454540968,0.0011972677893936634]),
]

class User(db.Model):
    __tablename__ = 'users'

    user_id = db.Column(db.Integer, primary_key=True)
    _descriptors = db.Column(db.String)
    is_deleted = db.Column(db.Boolean)
    last_update = db.Column(db.Integer)
    match_value = db.Column(db.Integer)
    match_index = db.Column(db.Integer)

    @property
    def descriptors(self):
        return json.loads(self._descriptors)

    @descriptors.setter
    def descriptors(self, value):
        self._descriptors = json.dumps(value)

    def __init__(self, user_id, descriptors, match_value, match_index):
        self.user_id = user_id
        self.descriptors = descriptors
        self.is_deleted = False
        self.last_update = time.time()
        self.match_value = match_value
        self.match_index = match_index


class Threshold(db.Model):
    __tablename__ = 'threshold'

    id = db.Column(db.Integer, primary_key=True)
    value = db.Column(db.Integer)

    def __init__(self, threshold):
        self.value = threshold



def calc_best_match(descriptors):
    matches = [calc_match(descriptors, secret_agent) for secret_agent in SECRET_AGENTS]
    best_match_value = max(matches)
    return matches.index(best_match_value), best_match_value


def calc_match(descriptors, secret_agent):
    distance1 = euclidean_distance(descriptors[0], secret_agent.descriptor)
    distance2 = euclidean_distance(descriptors[-1], secret_agent.descriptor)

    diff = distance1 - distance2
    maximal_potential_diff = distance1

    return 100 * diff / maximal_potential_diff


def euclidean_distance(desc1, desc2):
    return sum((a-b) * (a-b) for a,b in zip(desc1, desc2)) ** 0.5


@app.route('/registration')
def registration_page():
    return render_template('registration.html', SECRET_AGENTS=SECRET_AGENTS)


@app.route('/')
def index_page():
    return render_template('index.html', threshold=Threshold.query.first().value)


@app.route('/api/get_info')
def api_get_info():
    user_id = int(request.args.get('i'))
    signature = request.args.get('s')

    if not validate_signature(user_id, signature):
        return jsonify(False)

    user = User.query.get(user_id)

    if user and not user.is_deleted:
        return jsonify({
            'descriptors': user.descriptors, 
            'time_since_update': int(time.time() - user.last_update),
        })

    return jsonify('new')


@app.route('/api/register', methods=['POST'])
def api_register():
    user_id = int(request.form.get('id'))
    descriptors = json.loads(request.form.get('descriptors'))

    user = User.query.get(user_id)

    match_index, match_value = calc_best_match(descriptors)

    if user:
        # Update existing user
        user.descriptors = descriptors
        user.is_deleted = False
        user.last_update = time.time()
        user.match_value = match_value
        user.match_index = match_index
    else:
        # Register new user
        user = User(user_id, descriptors, match_value, match_index)
        db.session.add(user)

    db.session.commit()

    return jsonify({
        'time_since_update': 2,
    })


@app.route('/api/unregister', methods=['POST'])
def api_unregister():
    user_id = int(request.form.get('id'))
    
    user = User.query.get(user_id)

    if user:
        user.is_deleted = True
        user.last_update = time.time()

        db.session.commit()

    return ''


@app.route('/api/get_users')
def api_get_users():
    since_time = float(request.args.get('t'))

    users = User.query.filter(User.last_update > since_time).all()

    res = {'threshold': Threshold.query.first().value}
    if users:
        max_time = max(user.last_update for user in users)
        
        res = {
            'data': {user.user_id: {'label': str(user.user_id), 'descriptors': user.descriptors, 'match': user.match_value} for user in users if not user.is_deleted},
            'deleted': [user.user_id for user in users if user.is_deleted],
            't': max_time,
            'threshold': Threshold.query.first().value,
        }
    
    return jsonify(res)